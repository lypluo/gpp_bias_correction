---
title: "explore if the parameterization works well for the different individual sites"
author: "Yunpeng"
date: "7/12/2021"
output: html_document
---
In this script,using Koen's stress function

To select some sites to test if the parameter calibration works for each site-->
which serve as a baseline to find a solution that could calibrate all the sites:
selection crition and selected sites:
- criterion: have long period of observed gpp data; from different climate and veg types
- selected sites: 
  Cfa-DBF: US-MMS
  Cfb-DBF: DK-Sor
  Cfb-MF: BE-Vie
  Cfb-ENF: DE-Tha(no overestimation-->curious to see if model improves), NL-Loo
  Dfb-DBF: US-UMB
  Dfb-MF: US-PFa
  Dfb-ENF: RU-Fyo
  Dfc-ENF: FI-Hyy, IT-Ren(no overstimation-->curious to see if model improves)


### r setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(GenSA)
source("../R/frost_hardiness.R")
```

### (1) read data
```{r message=FALSE,warning=FALSE}
df_recent <- readRDS("../data/model_data.rds") %>%
  mutate(
    year = format(date, "%Y")
  ) %>%
  na.omit()

#load the data Beni sent me before:
df_old<-read.csv(file=paste0("../data/","ddf_fluxnet2015_pmodel_with_forcings_stocker19gmd.csv"))
df_old<-df_old %>%
  mutate(date=lubridate::mdy(date),
         year=lubridate::year(date)) %>%
  na.omit(gpp_obs,)
```

### (2) retreive the optimized parameter for the selected sites

```{r echo=FALSE, warning= FALSE}
# set initial value
par <- c(a = 1.5,b = -21.5,T8 = 11.3,t = 5,base_t = -25)

lower=c(0,-100,-50,1, -100)
upper=c(100,0,100,90, 0)

# run model and compare to true values
# returns the RMSE
cost <- function(
  data,
  par
  ) {

  scaling_factor <- data %>%
    # group_by(sitename) %>%
    do({
      scaling_factor <-frost_hardiness(
        .$tmin,
        par
      )

      data.frame(
        sitename = .$sitename,
        date = .$date,
        scaling_factor = scaling_factor
      )
    })

  df <- left_join(data, scaling_factor)

  rmse <- sqrt(
    sum(
      (df$gpp - df$gpp_mod * df$scaling_factor)^2)
    )/nrow(df)

  # This visualizes the process,
  # comment out when running for real
  # plot(df$gpp, type = 'p',ylim=c(0,12))
  # lines(df$gpp_mod, col = "red")
  # lines(df$gpp_mod * df$scaling_factor, col = "blue",cex=1.2)
  # Sys.sleep(0.1)

  return(rmse)
}

```

### optimize for different sites
```{r  warning= FALSE}
sel_sites<-c("US-MMS","DK-Sor","BE-Vie","DE-Tha","NL-Loo",
"US-UMB","US-PFa","RU-Fyo","FI-Hyy","IT-Ren")

### optimize for each site 
# library(tictoc)#-->record the parameterization time
# tic("start to parameterize")
# par_mutisites<-c()
# for(i in 1:length(sel_sites)){
#   df_sel<-df %>%
#     dplyr::filter(sitename==sel_sites[i])
#   
#   optim_par <- GenSA::GenSA(
#   par = par,
#   fn = cost,
#   data = df_sel,
#   lower = lower,
#   upper = upper,
#   control = list(max.call=100))$par
# 
#   print(i)
#   par_mutisites[[i]]<-optim_par
# }
# print("finish parameterization")
# toc()
# 
# names(par_mutisites)<-sel_sites
# print(par_mutisites)
#save the optimized data
# save(par_mutisites,file = paste0("./data/parameters/","optim_par_run100_koen_mutisites.rds"))
```

### compare the gpp_obs, ori modelled gpp, and gpp modelled using optimated parameters

```{r message=FALSE,warning=FALSE,include=FALSE}
load(paste0("../data/parameters/","optim_par_run100_koen_mutisites.rds"))
#include parameter-->include=FALSE-->Hide output results
print(par_mutisites)
```

```{r echo=FALSE,message=FALSE,warning=FALSE,include=FALSE}
#--------------------
#(1) get the stress function for each site and merge each sites datasets
#--------------------
# using the optimilized par
df_final<-c()
for (i in 1:length(sel_sites)) {
  df_sel<-df_recent %>%
    dplyr::filter(sitename==sel_sites[i])
  
  scaling_factors <- df_sel %>%
  # group_by(sitename, year) %>%
  do({
    scaling_factor <- frost_hardiness(.$tmin,par_mutisites[[i]])
    data.frame(
      sitename = .$sitename,
      date = .$date,
      scaling_factor_optim = scaling_factor
    )
  })
  df_sel <- left_join(df_sel, scaling_factors)
  
  #merge different sites:
  df_final<-rbind(df_final,df_sel)
}

#-------------------
#(2) calculate the simple stats for each site
#-------------------
#!!first need to merge the modelled gpp from different sources:
df_final$year<-lubridate::year(df_final$date)
df_merge<-left_join(df_final,df_old,by = c("sitename", "date", "year")) %>%
  mutate(gpp_obs_recent=gpp,
         gpp_obs_old=gpp_obs,
         gpp_mod_FULL_ori=gpp_mod_FULL,
         gpp_mod_recent_ori=gpp_mod,
         gpp_mod_recent_optim=gpp_mod*scaling_factor_optim,
         gpp=NULL,
         gpp_obs=NULL,
         gpp_mod=NULL)


library(sirad)
df_stats<-c()
for (i in 1:length(sel_sites)){
  df_each<-df_merge %>%
    dplyr::filter(sitename==sel_sites[i])
  #
  ori_model_evas<-modeval(df_each$gpp_mod_FULL_ori,df_each$gpp_obs_old,stat=c("N","pearson","MAE","RMSE","R2","slope","intercept","EF"))
  recent_model_evas<-modeval(df_each$gpp_mod_recent_ori,df_each$gpp_obs_recent,stat=c("N","pearson","MAE","RMSE","R2","slope","intercept","EF"))
  optim_par_model_evas<-modeval(df_each$gpp_mod_recent_optim,df_each$gpp_obs_recent,stat=c("N","pearson","MAE","RMSE","R2","slope","intercept","EF"))
  
  #
  stats_evals<-rbind(ori_model_evas,recent_model_evas,optim_par_model_evas)
  stats_evals
  #merge different sites
  df_stats[[i]]<-stats_evals
}
names(df_stats)<-sel_sites
print(df_stats)
```

### make evaluation plots

(1) For General plots
```{r echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
#evaluation using Beni's function:
devtools::load_all("D:/Github/rbeni/")
library(rbeni) #-->make the evaluation plot
library(cowplot)
library(grid)
```

```{r echo=FALSE,warning=FALSE,message=FALSE}
#--------------------------
#modelled and observed gpp:scatter plots
#-------------------------
plot_modobs_general<-c()
df_modobs<-c()
for(i in 1:length(sel_sites)){
  #
  df_modobs_each<-df_merge %>%
  filter(sitename==sel_sites[i]) %>%
  select(sitename,date,gpp_obs_recent,gpp_mod_FULL_ori,gpp_mod_recent_ori,gpp_mod_recent_optim) %>%
  mutate(gpp_obs=gpp_obs_recent,
         gpp_mod_old_ori=gpp_mod_FULL_ori,
         gpp_mod_recent_ori=gpp_mod_recent_ori,
         gpp_mod_recent_optim=gpp_mod_recent_optim) %>%
  mutate(gpp_obs_recent=NULL,
         gpp_mod_FULL_ori=NULL)
#
df_modobs<-rbind(df_modobs,df_modobs_each)

#scatter plots to compare the model and observation gpp
gpp_modobs_comp1<-df_modobs_each %>%
  analyse_modobs2("gpp_mod_old_ori", "gpp_obs", type = "heat")
gpp_modobs_comp2<-df_modobs_each %>%
  analyse_modobs2("gpp_mod_recent_ori", "gpp_obs", type = "heat")
gpp_modobs_comp3<-df_modobs_each %>%
  analyse_modobs2("gpp_mod_recent_optim", "gpp_obs", type = "heat")
# add the site-name:
gpp_modobs_comp1$gg<-gpp_modobs_comp1$gg+
  annotate(geom="text",x=15,y=0,label=sel_sites[i])
gpp_modobs_comp2$gg<-gpp_modobs_comp2$gg+
  annotate(geom="text",x=15,y=0,label=sel_sites[i])
gpp_modobs_comp3$gg<-gpp_modobs_comp3$gg+
  annotate(geom="text",x=15,y=0,label=sel_sites[i])

#merge two plots
evaulation_merge_plot<-plot_grid(gpp_modobs_comp1$gg,
    gpp_modobs_comp2$gg,gpp_modobs_comp3$gg,
    widths=15,heights=4,
labels = "auto",ncol =3,nrow = 1,label_size = 12,align = "hv")
plot(evaulation_merge_plot)

#put all the plots together:
plot_modobs_general[[i]]<-evaulation_merge_plot
}
names(plot_modobs_general)<-sel_sites

#print the plot
plot_modobs_general
```

(2) For Seasonality

```{r echo=FALSE,warning=FALSE,message=FALSE}
##------------
#By each site-->time series
#------------
# - selected sites: 
#   Cfa-DBF: US-MMS
#   Cfb-DBF: DK-Sor
#   Cfb-MF: BE-Vie
#   Cfb-ENF: DE-Tha(no much overestimation-->curious to see if model improves), NL-Loo
#   Dfb-DBF: US-UMB
#   Dfb-MF: US-PFa
#   Dfb-ENF: RU-Fyo
#   Dfc-ENF: FI-Hyy, IT-Ren(no much overstimation-->curious to see if model improves)

sel_sites<-c("US-MMS","DK-Sor","BE-Vie","DE-Tha","NL-Loo",
"US-UMB","US-PFa","RU-Fyo","FI-Hyy","IT-Ren")
sel_sites_type<-c("Cfa-DBF","Cfb-DBF","Cfb-MF","Cfb-ENF","Cfb-ENF",
                  "Dfb-DBF","Dfb-MF","Dfb-ENF","Dfc-ENF","Dfc-ENF")
#plotting:
  #Seasonal course by climate zone:
  season_plot<-df_modobs %>%
  mutate(doy = lubridate::yday(date)) %>%
  group_by(sitename, doy) %>%
  summarise(obs = mean(gpp_obs, na.rm = TRUE),
            mod_old_ori=mean(gpp_mod_old_ori, na.rm = TRUE),
            mod_recent_ori=mean(gpp_mod_recent_ori, na.rm = TRUE),
            mod_recent_optim=mean(gpp_mod_recent_optim,na.rm = TRUE)) %>%
  pivot_longer(c(obs,mod_old_ori,mod_recent_ori,mod_recent_optim), names_to = "Source", values_to = "gpp") %>%
  ggplot(aes(doy, gpp, color = Source)) +
  geom_line() +
  scale_color_manual(values = c("mod_old_ori" = "red","mod_recent_ori"="steelblue2",
                                "mod_recent_optim" = "orange", "obs" = "black"),
                     labels = c("Old P-model","Recent Ori P-model", "Recent Optim P-model","Obs.")) +
  labs(y = expression( paste("GPP (g C m"^-2, " d"^-1, ")" ) ),
       x = "Day of year") +
  annotate(geom="text",x=200,y=2,label="")+
  facet_wrap(~sitename)
  
#add the climate and PFT types:
#according the alaphetic order of the sites,i.e:
# BE-Vie, DE-Tha, DK-Sor, FI-Hyy, IT-Ren, NL-Loo, RU-Fyo, US-MMS, US-PFa, and US-UMB
dat_text<-data.frame(
  sitename=c("BE-Vie","DE-Tha", "DK-Sor", "FI-Hyy", "IT-Ren", "NL-Loo", "RU-Fyo", "US-MMS", "US-PFa", "US-UMB"),
  label=c("Cfb-MF","Cfb-ENF","Cfb-DBF","Dfc-ENF","Dfc-ENF","Cfb-ENF","Dfb-ENF","Cfa-DBF","Dfb-MF","Dfb-DBF"),
  Source=rep("Obs.",10), #add the "Source" vaiable to enable the plotting
  x=rep(200,10),
  y=rep(2,10)
)

season_plot<-season_plot+geom_text(
  data = dat_text,
  mapping = aes(x=x,y=y,label=label),
  col="black"
)

  
#print the plot
season_plot
```



