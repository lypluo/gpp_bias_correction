---
title: "explore if the parameterization works well for the different individual sites"
author: "Yunpeng"
date: "7/12/2021"
output: html_document
---
In this script,using Beni's stress function

To select some sites to test if the parameter calibration works for each site-->
which serve as a baseline to find a solution that could calibrate all the sites:
selection crition and selected sites:
- criterion: have long period of observed gpp data; from different climate and veg types
- selected sites: 
  Cfa-DBF: US-MMS
  Cfb-DBF: DK-Sor
  Cfb-MF: BE-Vie
  Cfb-ENF: DE-Tha(no overestimation-->curious to see if model improves), NL-Loo
  Dfb-DBF: US-UMB
  Dfb-MF: US-PFa
  Dfb-ENF: RU-Fyo
  Dfc-ENF: FI-Hyy, IT-Ren(no overstimation-->curious to see if model improves)


### r setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(GenSA)
source("../R/model_hardening_byBeni.R")
```

### (1) read data
```{r message=FALSE,warning=FALSE}
df <- readRDS("../data/model_data.rds") %>%
  mutate(
    year = format(date, "%Y")
  ) %>%
  na.omit()
```

### (2) retreive the optimized parameter for the selected sites

```{r echo=FALSE, message=FALSE, warning= FALSE}
# set initial value
par <- c("a" = 0, "b" = 0.5, "c" = 50, "d" = 0.1, "e" = 1)
lower=c(-50,0,0,0, 0)
upper=c(50,20,100,20,10)

# run model and compare to true values
# returns the RMSE
cost <- function(
  data,
  par
  ) {

  scaling_factor <- data %>%
    # group_by(sitename) %>%
    do({
      scaling_factor <- model_hardening(
        .,
        par
      )

      data.frame(
        sitename = .$sitename,
        date = .$date,
        scaling_factor = scaling_factor
      )
    })

  df <- left_join(df, scaling_factor)

  rmse <- sqrt(
    sum(
      (df$gpp - df$gpp_mod * df$scaling_factor)^2)
    )/nrow(df)

  # This visualizes the process,
  # comment out when running for real
  # plot(df$gpp, type = 'p',ylim=c(0,12))
  # lines(df$gpp_mod, col = "red")
  # lines(df$gpp_mod * df$scaling_factor, col = "blue",cex=1.2)
  # Sys.sleep(0.1)

  return(rmse)
}

sel_sites<-c("US-MMS","DK-Sor","BE-Vie","DE-Tha","NL-Loo",
"US-UMB","US-PFa","RU-Fyo","FI-Hyy","IT-Ren")

#
par_mutisites<-c()
for(i in 1:length(sel_sites)){
  df_sel<-df %>%
    dplyr::filter(sitename==sel_sites[i])
  
  optim_par <- GenSA::GenSA(
  par = par,
  fn = cost,
  data = df_sel,
  lower = lower,
  upper = upper,
  control = list(max.call=100,max.time=20))$par

  print(i)
  par_mutisites[[i]]<-optim_par
}
```

### optimize for each site 
```{r  warning= FALSE}
sel_sites<-c("US-MMS","DK-Sor","BE-Vie","DE-Tha","NL-Loo",
"US-UMB","US-PFa","RU-Fyo","FI-Hyy","IT-Ren")

#
par_mutisites<-c()
for(i in 1:length(sel_sites)){
  df_sel<-df %>%
    dplyr::filter(sitename==sel_sites[i])
  
  optim_par <- GenSA::GenSA(
  par = par,
  fn = cost,
  data = df_sel,
  lower = lower,
  upper = upper,
  control = list(maxit=100,max.call=100,max.time=20))$par

  print(i)
  par_mutisites[[i]]<-optim_par
}

```





#save the optimized data
save(optim_par,file = paste0("./data/parameters/","optim_par_run100_beni.rds"))
